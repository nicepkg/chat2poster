# 验收用例（Given / When / Then）

## 范围

- 覆盖扩展与官网两端的核心闭环：导入 → 选择 → 主题 → 分页 → 导出 → 错误恢复。
- 覆盖正常/异常/边界/空态/错误恢复/无权限与资源失败。

## 非范围

- 第三方平台账号权限、登录态管理（MVP 不做）。
- 云端持久化与协作（MVP 不做）。

## 假设

- 浏览器具备基本下载能力；zip 下载可用。
- 字体与图片资源在正常网络下可加载。

## 依赖

- 解析适配器与导出引擎可注入模拟（便于测试）。
- UI 支持可控的测试 ID（data-testid）。

---

## A. 扩展端：导入与默认选择

### A1 默认全选

Given 在 ChatGPT 对话页面存在 10 条消息  
When 用户打开扩展导出面板  
Then 消息列表应显示 10 条且全部为选中状态

### A2 全不选

Given 用户打开导出面板且默认全选  
When 点击“全不选”  
Then 所有消息变为未选中且导出按钮进入禁用状态（或提示需选择至少一条）

### A3 选择单条

Given 默认全选  
When 用户取消勾选其中 9 条，仅保留 1 条  
Then 预览仅显示 1 条消息内容，导出产物仅包含该条

---

## B. 主题与装饰

### B1 主题切换可见性

Given 当前主题为 Light  
When 切换到 Dark  
Then 预览在 300ms 内反映主题变化（颜色/背景/代码块风格）

### B2 装饰参数即时反馈

Given 当前圆角为 16px  
When 用户将圆角改为 32px  
Then 预览容器圆角应变为 32px

### B3 macOS 三色条开关

Given macOS 条开启  
When 用户关闭 macOS 条  
Then 预览顶部三色按钮条消失且导出图不包含该元素

---

## C. 超长提示与分页线

### C1 超长提示触发

Given 选中消息预估高度为 6500px  
When 用户查看预览区域  
Then 显示分页提示（提示文案包含“可分页”和入口）

### C2 超长提示不触发

Given 预估高度为 5000px  
When 查看预览  
Then 不显示分页提示

### C3 手动插入分页线

Given 消息列表 10 条且无分页线  
When 在第 3 条消息点击“在此后插入分页线”  
Then 在第 3 与第 4 条之间出现分页线，且导出将产生至少 2 页（若所有内容都能放进 1 页则仍以分页线为准强制分页）

### C4 删除分页线

Given 存在 2 条分页线  
When 用户删除其中 1 条  
Then 页数减少 1，页序号重新连续编号

---

## D. 自动分页

### D1 自动分页插入分页线并标注页序号

Given 选中消息预估高度 > 10000px 且无分页线  
When 用户点击“自动分页”，每张最大高度=4096px  
Then 列表中自动插入分页线，并显示“第 1 张、第 2 张…”标记

### D2 自动分页遵守最大高度

Given 每张最大高度=3000px  
When 自动分页完成  
Then 每一页导出图的内容高度 <= 3000px（允许页眉/外边距固定占用需计入规则中，具体由实现定义，但必须一致）

### D3 用户调整后重新导出

Given 自动分页生成 3 页  
When 用户将其中一条分页线移动位置并点击导出  
Then 导出页内容应按新分页线重新分配，且不沿用旧结果

---

## E. 导出

### E1 单张导出 PNG

Given 选中少量消息且无分页线  
When 用户导出，倍率=2x  
Then 下载 1 个 PNG 文件，像素宽度=预览宽度*2（或定义的画布宽度*2）

### E2 多张导出 zip

Given 存在分页线或自动分页生成 N>1 页  
When 用户点击导出  
Then 下载 1 个 zip 文件，包含 N 个 PNG，文件名按页序号递增（001.png, 002.png…）

### E3 倍率 1x/2x/3x 生效

Given 相同内容导出  
When 分别选择 1x、2x、3x 导出  
Then 三者输出像素宽度比例为 1:2:3

---

## F. 错误处理与恢复

### F1 导出失败可重试且不清空选择

Given 导出过程中 SnapDOM 抛错  
When UI 展示导出失败  
Then 显示“重试”按钮，且消息选择与分页线保持不变

### F2 资源加载失败提示

Given 预览中存在图片但加载失败  
When 用户点击导出  
Then 提示图片资源失败并提供“重试加载”或“忽略图片继续导出”选项（MVP 可选其一，但必须明确）

---

## G. 官网：share link 与兜底手动创建

### G1 share link 解析成功

Given 用户粘贴受支持的 share link  
When 点击“解析”  
Then 出现 message list，默认全选，可进入导出流程

### G2 share link 解析失败兜底

Given 用户粘贴不受支持的 share link  
When 点击“解析”  
Then 显示失败原因与两个入口：手动创建消息 / 粘贴文本导入

### G3 手动创建消息列表

Given 用户进入手动创建  
When 添加 3 条消息（role + markdown）并点击导出  
Then 导出图内容与输入一致，role 样式正确

### G4 手动创建默认 role 交替

Given 用户在手动创建添加第一条为 user  
When 用户点击“新增下一条”  
Then 下一条默认 role 为 assistant（可手动修改）

---

## H. 隐私与数据处理（官网）

### H1 不落库

Given 用户通过官网解析 share link  
When 完成导出  
Then 服务端不得保存消息正文到持久存储（验收方式：配置/代码审查 + 日志抽检）

### H2 日志不包含正文

Given 解析失败/成功均可能产生日志  
When 抽检服务端日志  
Then 不得出现 message 文本片段（可出现错误码、长度、耗时、adapter id/version）
